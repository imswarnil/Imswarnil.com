{{!-- 
    PARTIAL: course/lessons-aside
    USAGE: In lesson template sidebar (inside {{#post}})
           {{> "course/lessons-aside"}}
    PURPOSE: Show all lessons in the same course (same primary_tag + #lesson),
             highlight current lesson, show tiny thumb, title, short excerpt.
--}}

<style>
    .lesson-sidebar-nav {
        border-radius: var(--radius-4);
        border: 1px solid var(--color-border);
        background: var(--color-background-100);
        padding: var(--spacing-4);
        margin-bottom: var(--spacing-6);
        position: relative;
    }

    .lesson-sidebar-title {
        font-size: 0.85rem;
        font-weight: var(--font-weight-bold);
        text-transform: uppercase;
        letter-spacing: 0.09em;
        color: var(--color-secondary);
        margin: 0 0 var(--spacing-3);
    }

    /* subtle vertical spine */
    .lesson-sidebar-list {
        list-style: none;
        margin: 0;
        padding: 2px 0 0 0;
        display: flex;
        flex-direction: column;
        gap: 4px;
        position: relative;
    }

    .lesson-sidebar-list::before {
        content: "";
        position: absolute;
        left: 20px;
        top: 2px;
        bottom: 4px;
        width: 2px;
        background: linear-gradient(
            to bottom,
            color-mix(in srgb, var(--color-border), transparent 10%),
            color-mix(in srgb, var(--color-border), transparent 40%)
        );
        opacity: 0.85;
        pointer-events: none;
    }

    .lesson-sidebar-item {
        border-radius: var(--radius-3);
        overflow: hidden;
        position: relative;
    }

    .lesson-sidebar-link {
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 8px;
        align-items: center;
        padding: 6px 8px;
        font-size: 0.82rem;
        color: var(--color-foreground);
        text-decoration: none;
        border-radius: inherit;
        border: 1px solid transparent;
        background: transparent;
        transition: background 0.15s ease-out, border-color 0.15s ease-out, transform 0.15s ease-out;
        position: relative;
    }

    /* dot on the spine */
    .lesson-sidebar-link::before {
        content: "";
        position: absolute;
        left: 18px;
        top: 50%;
        transform: translateY(-50%);
        width: 9px;
        height: 9px;
        border-radius: 999px;
        background: var(--color-background);
        border: 1px solid var(--color-border);
        z-index: 1;
    }

    .lesson-sidebar-link.is-locked {
        cursor: default;
    }

    .lesson-sidebar-item:not(.is-active) .lesson-sidebar-link:hover {
        background: var(--color-background);
        border-color: var(--color-border);
        transform: translateY(-1px);
    }

    /* active state */
    .lesson-sidebar-item.is-active .lesson-sidebar-link {
        background: var(--color-background);
        border-color: var(--ghost-accent-color);
    }

    .lesson-sidebar-item.is-active .lesson-sidebar-link::before {
        background: var(--ghost-accent-color);
        border-color: var(--ghost-accent-color);
    }

    /* thumb â€“ smaller */
    .lesson-sidebar-thumb {
        width: 36px;
        height: 36px;
        border-radius: var(--radius-2);
        overflow: hidden;
        flex-shrink: 0;
        border: 1px solid var(--color-border);
        background: var(--color-background-200);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .lesson-sidebar-thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    .lesson-sidebar-thumb-placeholder {
        font-size: 0.7rem;
        color: var(--color-secondary);
    }

    /* text block */
    .lesson-sidebar-text {
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 1px;
    }

    .lesson-sidebar-topline {
        display: flex;
        align-items: center;
        gap: 6px;
        min-width: 0;
    }

    /* NUMBER BADGE */
    .lesson-sidebar-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 20px;
        height: 20px;
        padding: 0 6px;
        border-radius: 999px;
        font-family: var(--font-family-headings);
        font-weight: var(--font-weight-medium);
        font-size: 0.7rem;
        color: var(--color-secondary);
        border: 1px solid var(--color-border);
        background: var(--color-background-200);
    }

    .lesson-sidebar-item.is-active .lesson-sidebar-number {
        border-color: var(--ghost-accent-color);
        background: color-mix(in srgb, var(--ghost-accent-color) 12%, var(--color-background));
        color: var(--ghost-accent-color);
    }

    .lesson-sidebar-name {
        font-family: var(--font-family-headings);
        font-size: 0.86rem;
        font-weight: var(--font-weight-medium);
        color: var(--color-contrast);
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
    }

    /* truncated description */
    .lesson-sidebar-excerpt {
        font-size: 0.74rem;
        color: var(--color-secondary);
        display: -webkit-box;
        -webkit-line-clamp: 1;      /* keep it minimal */
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* status pill */
    .lesson-sidebar-status {
        font-size: 0.7rem;
        padding: 2px 7px;
        border-radius: 999px;
        border: 1px solid var(--color-border);
        color: var(--color-secondary);
        white-space: nowrap;
    }

    .lesson-sidebar-status--free {
        border-color: var(--ghost-accent-color);
        color: var(--ghost-accent-color);
    }

    .lesson-sidebar-status--locked {
        border-color: rgba(195,77,77,.5);
        color: var(--color-error);
        background: rgba(195,77,77,.06);
    }

    .lesson-sidebar-status--current {
        border-color: var(--ghost-accent-color);
        background: var(--ghost-accent-color);
        color: #fff;
    }

    @media (max-width: 640px) {
        .lesson-sidebar-link {
            padding: 5px 7px;
            gap: 6px;
        }

        .lesson-sidebar-thumb {
            width: 32px;
            height: 32px;
        }

        .lesson-sidebar-name {
            font-size: 0.82rem;
        }

        .lesson-sidebar-list::before {
            left: 18px;
        }

        .lesson-sidebar-link::before {
            left: 16px;
        }
    }
</style>

{{!-- DATA + MARKUP --}}
{{#if primary_tag}}
    {{#get
        "posts"
        filter=(concat "tag:hash-lesson+tag:" primary_tag.slug)
        include="tags"
        limit="all"
        order="published_at asc"
    }}
        {{#if posts}}
            <nav class="lesson-sidebar-nav" aria-label="{{t "Course lessons"}}">
                <h3 class="lesson-sidebar-title">
                    {{t "Lessons in this course"}}
                </h3>

                <ol class="lesson-sidebar-list">
                    {{#foreach posts}}
                        {{!-- Compare lesson slug to current page slug (outer post context) --}}
                        {{#match slug ../../slug}}
                            {{!-- ACTIVE LESSON --}}
                            <li class="lesson-sidebar-item is-active">
                                <div class="lesson-sidebar-link">
                                    <div class="lesson-sidebar-thumb">
                                        {{#if feature_image}}
                                            <img src="{{img_url feature_image size="xs"}}" alt="{{title}}">
                                        {{else}}
                                            <span class="lesson-sidebar-thumb-placeholder">â–¶</span>
                                        {{/if}}
                                    </div>

                                    <div class="lesson-sidebar-text">
                                        <div class="lesson-sidebar-topline">
                                            <span class="lesson-sidebar-number">
                                                {{@number}}
                                            </span>
                                            <span class="lesson-sidebar-name">
                                                {{title}}
                                            </span>
                                        </div>

                                        {{#if custom_excerpt}}
                                            <span class="lesson-sidebar-excerpt">
                                                {{custom_excerpt}}
                                            </span>
                                        {{else if excerpt}}
                                            <span class="lesson-sidebar-excerpt">
                                                {{excerpt}}
                                            </span>
                                        {{/if}}
                                    </div>

                                    <span class="lesson-sidebar-status lesson-sidebar-status--current">
                                        {{t "Now"}}
                                    </span>
                                </div>
                            </li>
                        {{else}}
                            {{!-- OTHER LESSONS --}}
                            <li class="lesson-sidebar-item">
                                {{#if access}}
                                    <a href="{{url}}" class="lesson-sidebar-link">
                                        <div class="lesson-sidebar-thumb">
                                            {{#if feature_image}}
                                                <img src="{{img_url feature_image size="xs"}}" alt="{{title}}">
                                            {{else}}
                                                <span class="lesson-sidebar-thumb-placeholder">â–¶</span>
                                            {{/if}}
                                        </div>

                                        <div class="lesson-sidebar-text">
                                            <div class="lesson-sidebar-topline">
                                                <span class="lesson-sidebar-number">
                                                    {{@number}}
                                                </span>
                                                <span class="lesson-sidebar-name">
                                                    {{title}}
                                                </span>
                                            </div>

                                            {{#if custom_excerpt}}
                                                <span class="lesson-sidebar-excerpt">
                                                    {{custom_excerpt}}
                                                </span>
                                            {{else if excerpt}}
                                                <span class="lesson-sidebar-excerpt">
                                                    {{excerpt}}
                                                </span>
                                            {{/if}}
                                        </div>

                                        <span class="lesson-sidebar-status lesson-sidebar-status--free">
                                            â–¶
                                        </span>
                                    </a>
                                {{else}}
                                    <div class="lesson-sidebar-link is-locked">
                                        <div class="lesson-sidebar-thumb">
                                            {{#if feature_image}}
                                                <img src="{{img_url feature_image size="xs"}}" alt="{{title}}">
                                            {{else}}
                                                <span class="lesson-sidebar-thumb-placeholder">ðŸ”’</span>
                                            {{/if}}
                                        </div>

                                        <div class="lesson-sidebar-text">
                                            <div class="lesson-sidebar-topline">
                                                <span class="lesson-sidebar-number">
                                                    {{@number}}
                                                </span>
                                                <span class="lesson-sidebar-name">
                                                    {{title}}
                                                </span>
                                            </div>

                                            {{#if custom_excerpt}}
                                                <span class="lesson-sidebar-excerpt">
                                                    {{custom_excerpt}}
                                                </span>
                                            {{else if excerpt}}
                                                <span class="lesson-sidebar-excerpt">
                                                    {{excerpt}}
                                                </span>
                                            {{/if}}
                                        </div>

                                        <span class="lesson-sidebar-status lesson-sidebar-status--locked">
                                            ðŸ”’
                                        </span>
                                    </div>
                                {{/if}}
                            </li>
                        {{/match}}
                    {{/foreach}}
                </ol>
            </nav>
        {{/if}}
    {{/get}}
{{/if}}
